<html>

  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="http://www.html5canvastutorials.com/libraries/kinetic-v3.10.0.js"></script>
    <script>
      var maxValue = 13;
      var minValue = 1;
      var snapArea = { 'x': 400, 'y': 300 }
      var colors   = ['red', 'black'];
      var suites   = ['club', 'spade', 'heart', 'diamond'];
      var names    = { '11': 'Jack', '12': 'Queen', '13': 'King', '1': 'Ace' }
      var cardheight = 244;
      var cardwidth  = 167;
      var cardsnap   = 30;
      var cardsprite = {
        'club1': { 'x': 0, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club2': { 'x': cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club3': { 'x': 2*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club4': { 'x': 3*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club5': { 'x': 4*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club6': { 'x': 5*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club7': { 'x': 6*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club8': { 'x': 7*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club9': { 'x': 8*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club10': { 'x': 9*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club11': { 'x': 10*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club12': { 'x': 11*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'club13': { 'x': 12*cardwidth, 'y': 0, 'width': cardwidth, 'height': cardheight },
        'diamond1': { 'x': 0, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond2': { 'x': cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond3': { 'x': 2*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond4': { 'x': 3*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond5': { 'x': 4*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond6': { 'x': 5*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond7': { 'x': 6*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond8': { 'x': 7*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond9': { 'x': 8*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond10': { 'x': 9*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond11': { 'x': 10*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond12': { 'x': 11*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'diamond13': { 'x': 12*cardwidth, 'y': cardheight, 'width': cardwidth, 'height': cardheight },
        'heart1': { 'x': 0, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart2': { 'x': cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart3': { 'x': 2*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart4': { 'x': 3*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart5': { 'x': 4*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart6': { 'x': 5*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart7': { 'x': 6*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart8': { 'x': 7*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart9': { 'x': 8*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart10': { 'x': 9*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart11': { 'x': 10*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart12': { 'x': 11*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'heart13': { 'x': 12*cardwidth, 'y': 2*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade1': { 'x': 0, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade2': { 'x': cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade3': { 'x': 2*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade4': { 'x': 3*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade5': { 'x': 4*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade6': { 'x': 5*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade7': { 'x': 6*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade8': { 'x': 7*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade9': { 'x': 8*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade10': { 'x': 9*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade11': { 'x': 10*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade12': { 'x': 11*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight },
        'spade13': { 'x': 12*cardwidth, 'y': 3*cardheight, 'width': cardwidth, 'height': cardheight }
      };

      var card = function(value, color, suite) {
        this.value = value || null;
        this.color = color || null;
        this.suite = suite || null;
        if (this.value === null || this.color === null || this.suite === null) {
          //Will return 0 thru 3
          this.suite = suites[Math.floor(Math.random() * (suites.length))];
          //Color depends on the suite.
          if (this.suite === 'club' || this.suite === 'spade') {
            this.color = colors[1];
          } else {
            this.color = colors[0];
          }
          //Will return 1-13
          this.value = Math.floor(Math.random() * (maxValue - minValue + 1)) + minValue;
        }
        if (this.value > 10 || this.value === 1) {
          this.name = names[this.value] + ' of ' + this.suite + 's';
        } else {
          this.name = this.value + ' of ' + this.suite + 's';
        }
      }

      var deck = function() {
        this.numberInDeck = 0;
        this.maxInDeck    = 52;
        this.cards  = [];
        this.inDeck = {};

        //Initializes the deck.
        for (var x=0; x<this.maxInDeck; x++) {
          // Create a new card.
          var newCard = new card();
          // If this suite is not in the deck
          if (!(newCard.suite in this.inDeck)) {
            // Add the card to the deck. Also put it in the inDeck index so we can better determine
            // what cards are in the deck.
            this.inDeck[newCard.suite] = [newCard.value];
            this.cards.push(newCard);
            this.numberInDeck ++;
          } else {
            // If this suite was in the deck already, if the value isn't in, add it.
            if (this.inDeck[newCard.suite].indexOf(newCard.value) === -1) {
              this.inDeck[newCard.suite][newCard.value] = newCard.value;
              this.cards.push(newCard);
              this.numberInDeck ++;
            } else {
              x--;
            }
          }
        }

        this.deal = function(callback) {
          var card = this.cards.pop();
          this.numberInDeck--;
          delete this.inDeck[card.suite][card.value];
          callback(card);
        }

      }

      var isNearSnapArea = function(image, snapArea) {
        if (image.attrs.x > snapArea.x - 30 && image.attrs.x < snapArea.x + 30 && image.attrs.y > snapArea.y - 30 && image.attrs.y < snapArea.y + 30) {
          return true;
        } else {
          return false;
        }
      }
      var isNearCardSnapArea = function(image, layer, callback) {
        console.log(layer.children);
        // What the new card will snap to if it is near it
        var snapTo = { 'x': image.attrs.x, 'y': image.attrs.y };
        for (var x = 0; x < layer.children.length; x++) {
          var card   = { 'x': layer.children[x].attrs.x, 'y': layer.children[x].attrs.y, '_id': layer.children[x]._id, 'type': layer.children[x].type }
          if(isNearSnapArea(image, card) && card.type === 'card' && image._id !== card._id) {
            snapTo.x = card.x;
            snapTo.y = card.y + 30;
            callback(snapTo);
            return;
          }
        }
      }


      $(document).ready(function() {
        var newDeck = new deck();
        var stage = new Kinetic.Stage({
          container: "container",
          width: 600,
          height: 400
        });
        var layer = new Kinetic.Layer();
        var rect = new Kinetic.Rect({
          x: snapArea.x,
          y: snapArea.y,
          width: 75,
          height: 100,
          fill: "#00D2FF",
          stroke: "black",
          strokeWidth: 4
        });
        layer.add(rect);
        stage.add(layer);

        $('#deckCount1').html(newDeck.numberInDeck);
        $('#dealbutton').click(function() {
          newDeck.deal(function(card) {
            var imageObj = new Image();
            imageObj.onload = function() {
              var image = new Kinetic.Image({
                x: stage.getWidth() / 2 - 53,
                y: stage.getHeight() / 2 - 59,
                crop: cardsprite[card.suite + card.value],
                width: 75,
                height: 100,
                image: imageObj,
                draggable: true,
                offset: [75/2, 100/2]
              });
              image.type    = "card";
              image.tapped  = false;
              image.tap     = function() {
                if(!image.tapped) {
                  image.rotateDeg(90);
                } else {
                  image.rotateDeg(-90);
                }
                image.tapped = !(image.tapped);
              }
              layer.add(image);
              stage.add(layer);
              image.on("mouseover", function() {
                document.body.style.cursor = "pointer";
              });
              image.on("mouseout", function() {
                document.body.style.cursor = "default";
              });
              image.on('dragstart', function() {
                image.moveToTop();
              });
              image.on('dblclick', function() {
                image.tap();
                layer.draw();
              });
              image.on('dragend', function() {
                // If this is near the right side, snap the card to it.
                if(isNearSnapArea(image, snapArea)) {
                  image.attrs.x = snapArea.x;
                  image.attrs.y = snapArea.y;
                  layer.draw();
                }
                isNearCardSnapArea(image, layer, function(snapTo) { 
                  image.attrs.x = snapTo.x;
                  image.attrs.y = snapTo.y;
                  layer.draw();
                }); 
              });
            }
            imageObj.src = 'card_sprite.png';
            var notificationText = "<p>Dealt one card. It was a " + card.name + " with a value of " + card.value + ", suite of " + card.suite + ", and color of " + card.color + ".</p> ";
            $(notificationText).hide().prependTo('#actionarea').slideToggle("slow");
            $('#deckCount1').html(newDeck.numberInDeck);
          });
        });
      });
    </script>
    <style type="text/css">
      body {
        margin: 0px;
        padding: 0px;
      }
      canvas {
        border: 1px solid #9C9898;
      }
    </style>
  </head>
  <body>
    <h1>Some deck tests</h1>
    <div id="container"></div>
    <p>Deck has <span id="deckCount1">number of</span> cards in it.</p>
    <input id="dealbutton" type="button" value="Deal 1 Card"/>
    <div id="actionarea"></div>
  </body>
</html>
